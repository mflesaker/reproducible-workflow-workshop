---
title: "Analysis"
author: "YOUR NAME"
date: today
format: html
---

## Overview

This document creates tables and figures for the manuscript.

## Setup

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(gtsummary)
library(gt)
library(here)
```

## Load Cleaned Data

```{r}
#| label: load-data

# Load cleaned data from data-cleaning.qmd
data_clean <- readRDS(here("results", "data_clean.rds"))
```

## The repetitive approach

```{r}
#| label: repetitive-regression
#| eval: false

library(broom)  # tidy() function to convert model output to data frame

# Model for blood pressure
model_bp <- data_clean |>
  lm(BPSysAve ~ Education + Age + Gender, data = _)

# tidy() converts model output to a clean data frame with columns:
#   term, estimate, std.error, statistic, p.value, conf.low, conf.high
# str_detect() finds rows where "term" contains "Education"
tidy(model_bp, conf.int = TRUE) |>
  filter(str_detect(term, "Education"))

# Model for BMI (copy-paste and change outcome variable...)
model_bmi <- data_clean |>
  lm(BMI ~ Education + Age + Gender, data = _)

tidy(model_bmi, conf.int = TRUE) |>
  filter(str_detect(term, "Education"))
```

## Building the regression function

```{r}
#| label: define-regression-function

# Function to run education model for any outcome
fit_education_model <- function(data, outcome_var) {
  # as.formula() + paste() creates formula from string
  # e.g., "BPSysAve" becomes: BPSysAve ~ Education + Age + Gender
  formula <- as.formula(paste(outcome_var, "~ Education + Age + Gender"))

  data |>
    lm(formula, data = _) |>
    # tidy() converts lm output to a data frame
    tidy(conf.int = TRUE) |>
    # Keep only Education-related coefficients
    filter(str_detect(term, "Education")) |>
    # Add column to track which outcome this is
    mutate(outcome = outcome_var)
}
```

## Using the regression function (one at a time)

```{r}
#| label: use-regression-function

# Now the analysis is simple and clear
data_clean |> fit_education_model("BPSysAve")
data_clean |> fit_education_model("BMI")
```

## Using map() to iterate the regression function

```{r}
#| label: use-map

outcomes <- c("BPSysAve", "BMI")

# map() runs the function for each element in outcomes
# \(y) is shorthand for function(y) - an "anonymous function"
# list_rbind() stacks the results into one data frame
results <- map(outcomes, \(y) data_clean |> fit_education_model(y)) |>
  list_rbind()

results
```

## Subgroup analysis

```{r}
#| label: subgroup-function

# Function to run model within each level of a grouping variable
fit_model_by_group <- function(data, group_var) {
  data |>
    # nest_by() splits data by group, storing each subset in a "data" column
    # e.g., for Gender: one row for "male" with all male data,
    #                   one row for "female" with all female data
    nest_by({{ group_var }}) |>
    # reframe() runs the model on each group's data and returns multiple rows
    # (summarize() expects 1 row per group; reframe() allows many)
    reframe(
      tidy(lm(BPSysAve ~ Education + Age, data = data), conf.int = TRUE)
    ) |>
    # Keep only the College Grad coefficient (vs 8th Grade reference)
    filter(term == "EducationCollege Grad")
}
```

### Use with different grouping variables

```{r}
#| label: use-subgroup-function

# Stratify by Gender
data_clean |> fit_model_by_group(Gender)

# Stratify by Race â€” same function, different variable!
data_clean |> fit_model_by_group(Race1)
```



## Table 1: Participant Characteristics

```{r}
#| label: tbl-demographics
#| tbl-cap: "Participant characteristics"

data_clean |>
  mutate(Gender = str_to_title(Gender)) |>
  select(Education, Age, Gender, Race1, BPSysAve) |>
  tbl_summary(
    by = Education,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = list(
      Age ~ "Age (years)",
      Gender ~ "Sex",
      Race1 ~ "Race/Ethnicity",
      BPSysAve ~ "Systolic BP (mmHg)"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  bold_labels()
```

## Figure 1: Main Result

```{r}
#| label: fig-main
#| fig-cap: "Main result figure"

# TODO: Create main figure using ggplot2
# ggplot(data_clean, aes(x = ..., y = ...)) +
#   geom_point() +
#   theme_minimal()
```

## Table 2: Main Analysis

```{r}
#| label: tbl-main
#| tbl-cap: "Main analysis results"

# TODO: Create analysis table
# Example: regression results with tbl_regression()
```

## Additional Figures

```{r}
#| label: fig-additional
#| fig-cap: "Additional figure"

# TODO: Add additional figures as needed
```
