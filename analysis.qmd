---
title: "Analysis"
author: "Michelle Flesaker"
date: today
format: html
---

## Overview

This document creates tables and figures for the manuscript.

## Setup

```{r}
#| label: setup
#| message: false

library(tidyverse)
library(gtsummary)
library(gt)
library(here)
library(broom)
```

## Load Cleaned Data

```{r}
#| label: load-data

# Load cleaned data from data-cleaning.qmd
data_clean <- readRDS(here("results", "data_clean.rds"))
```

## The repetitive approach

```{r}
#| label: repetitive-regression
#| eval: false

library(broom)  # tidy() function to convert model output to data frame

# Model for blood pressure
model_bp <- data_clean |>
  lm(BPSysAve ~ Education + Age + Gender, data = _)

# tidy() converts model output to a clean data frame with columns:
#   term, estimate, std.error, statistic, p.value, conf.low, conf.high
# str_detect() finds rows where "term" contains "Education"
tidy(model_bp, conf.int = TRUE) |>
  filter(str_detect(term, "Education"))

# Model for BMI (copy-paste and change outcome variable...)
model_bmi <- data_clean |>
  lm(BMI ~ Education + Age + Gender, data = _)

tidy(model_bmi, conf.int = TRUE) |>
  filter(str_detect(term, "Education"))
```

## Building the regression function

```{r}
#| label: define-regression-function

# Function to run education model for any outcome
fit_education_model <- function(data, outcome_var) {
  
  # as.formula() + paste() creates formula from string
  # e.g., "BPSysAve" becomes: BPSysAve ~ Education + Age + Gender
  formula <- as.formula(paste(outcome_var, "~ Education + Age + Gender"))

  data |>
    lm(formula, data = _) |>
    # tidy() converts lm output to a data frame
    tidy(conf.int = TRUE) |>
    # Keep only Education-related coefficients
    filter(str_detect(term, "Education")) |>
    # Add column to track which outcome this is
    mutate(outcome = outcome_var)
}
```

## Using the regression function (one at a time)

```{r}
#| label: use-regression-function

# Now the analysis is simple and clear
data_clean |> fit_education_model("BPSysAve")
data_clean |> fit_education_model("BMI")
```

## Using map() to iterate the regression function

```{r}
#| label: use-map

outcomes <- c("BPSysAve", "BMI")

# map() runs the function for each element in outcomes
# \(y) is shorthand for function(y) - an "anonymous function"
# list_rbind() stacks the results into one data frame
results <- map(outcomes, \(y) data_clean |> fit_education_model(y)) |>
  list_rbind()

results
```

## Subgroup analysis

```{r}
#| label: subgroup-function

# Function to run model within each level of a grouping variable
fit_model_by_group <- function(data, group_var) {
  data |>
    # nest_by() splits data by group, storing each subset in a "data" column
    # e.g., for Gender: one row for "male" with all male data,
    #                   one row for "female" with all female data
    nest_by({{ group_var }}) |>
    # reframe() runs the model on each group's data and returns multiple rows
    # (summarize() expects 1 row per group; reframe() allows many)
    reframe(
      tidy(lm(BPSysAve ~ Education + Age, data = data), conf.int = TRUE)
    ) |>
    # Keep only the College Grad coefficient (vs 8th Grade reference)
    filter(term == "EducationCollege Grad")
}
```

## Use with different grouping variables

```{r}
#| label: use-subgroup-function

# Stratify by Gender
data_clean |> fit_model_by_group(Gender)

# Stratify by Race — same function, different variable!
data_clean |> fit_model_by_group(Race1)
```

## Table 1: Participant Characteristics

```{r}
#| label: tbl-demographics
#| tbl-cap: "Participant characteristics by education level"

data_clean |>
  mutate(Gender = str_to_title(Gender)) |>
  select(Education, Age, Gender, Race1, BPSysAve) |>
  tbl_summary(
    by = Education,
    statistic = list(
      all_continuous() ~ "{mean} ({sd})",
      all_categorical() ~ "{n} ({p}%)"
    ),
    label = list(
      Age ~ "Age (years)",
      Gender ~ "Sex",
      Race1 ~ "Race/Ethnicity",
      BPSysAve ~ "Systolic BP (mmHg)"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  bold_labels()
```

## Fit the linear regression model

```{r}
# Model: Blood pressure ~ Education + covariates
model_fit <- lm(BPSysAve ~ Education + Gender + Race1, data = data_clean)

# View the results
summary(model_fit)
```

## Figure 1: Main Result (Box Plot)

```{r}
#| label: fig-bp-education
#| fig-cap: "Distribution of systolic BP by education level"
#| fig-width: 7
#| fig-height: 5

data_clean |>
  ggplot(aes(x = Education, y = BPSysAve, fill = Education)) +
  geom_boxplot(alpha = 0.7) +
  stat_summary(
    fun = mean,
    geom = "point",
    shape = 18,
    size = 3,
    color = "darkred"
  ) +
  labs(
    x = "Education Level",
    y = "Systolic Blood Pressure (mmHg)",
    title = "Blood Pressure Distribution by Education Level"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
```

As shown in `@tbl-demographics`, participants varied by education level.

Blood pressure distribution is visualized in `@fig-bp-education`.

## Table 2: Main Analysis

```{r}
#| label: tbl-main
#| tbl-cap: "Association between education level and systolic blood pressure"

model_fit |>
  tbl_regression(
    label = list(
      Education ~ "Education level",
      Gender ~ "Sex",
      Race1 ~ "Race/ethnicity"
    )
  ) |>
  bold_labels()
```

Results of the linear regression are shown in `@tbl-main`.

## Comparisons - Fit two models 

```{r}
#| label: fit-two-models

# Model 1: Without age adjustment
model_crude <- lm(BPSysAve ~ Education + Gender + Race1, data = data_clean)

# Model 2: With age adjustment
model_adjusted <- lm(BPSysAve ~ Education + Gender + Race1 + Age, data = data_clean)
```

## Extract and compare coefficients

```{r}
#| label: compare-models

# Extract College Grad coefficient from both models
crude_result <- model_crude |>
  tidy(conf.int = TRUE) |>
  filter(term == "EducationCollege Grad") |>
  mutate(model = "Crude (no age)")

adjusted_result <- model_adjusted |>
  tidy(conf.int = TRUE) |>
  filter(term == "EducationCollege Grad") |>
  mutate(model = "Age-adjusted")

# Combine into comparison table
comparison <- bind_rows(crude_result, adjusted_result) |>
  select(model, estimate, conf.low, conf.high, p.value)

comparison
```

## Visualize the comparison

```{r}
#| label: fig-comparison
#| fig-cap: "Comparison of crude and age-adjusted estimates for College Grad vs 8th Grade"
#| fig-width: 6
#| fig-height: 3

comparison |>
  ggplot(aes(x = estimate, y = model)) +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray50") +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.2) +
  geom_point(size = 3, color = "steelblue") +
  labs(
    x = "Difference in systolic BP (mmHg)\nCollege Grad vs. 8th Grade",
    y = NULL
  ) +
  theme_minimal(base_size = 12)
```

## Create a publication-ready table

```{r}
#| label: tbl-comparison
#| tbl-cap: "Comparison of crude and age-adjusted estimates for education-BP association"

comparison |>
  gt() |>
  fmt_number(columns = c(estimate, conf.low, conf.high), decimals = 1) |>
  fmt_number(columns = p.value, decimals = 3) |>
  cols_merge(
    columns = c(conf.low, conf.high),
    pattern = "({1}, {2})"
  ) |>
  cols_label(
    model = "Model",
    estimate = "β",
    conf.low = "95% CI",
    p.value = "P-value"
  )
```




